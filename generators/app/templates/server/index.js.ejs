const express = require('express');
const request = require('request');
const config = require('../configs/config');
const app = express();<% if (templateEngine.indexOf('mangony') !== -1 && mangonyExpress === true) { %>
const deepExtend = require('deep-extend');
const Mangony = require('mangony');
const mangonyOptions = require('../configs/tasks/mangony.config');
const mangonyDevOptions = deepExtend(mangonyOptions.dev.options, {
	devServer: {
		express: app
	}
});
const mangonyServer = new Mangony(deepExtend(mangonyOptions.options, mangonyDevOptions));

/**
 * Register routes and start express server
 *
 */
mangonyServer.render();

<% } %>
/**
 * parameter passing from grunt
 * @type {Array}
 */
const args = process.argv;
/**
 * the keys of apiServerHosts are
 * used to implement the routing
 * localhost:[port]/veams is proxied
 * to https://github.com/Veams
 * @type {Object}
 */
const apiServerHosts = {
	'veams': 'https://github.com/Veams'
};

const apiServerHostRoutes = [];

Object.keys(apiServerHosts).forEach(function (route) {
	apiServerHostRoutes.push('/' + route);
	apiServerHostRoutes.push('/' + route + '.json');
});

app.use(apiServerHostRoutes, function (req, res) {
	let key, url;
	let format = '';

	key = req.originalUrl.substring(1, req.originalUrl.length);

	if (key.indexOf('.json') !== -1) {
		key = key.replace('.json', '');
		format = '.json';
	}

	url = apiServerHosts[key] + req.url + format;

	req.pipe(request(url)).pipe(res);
});

// an example route for an API
app.get('/test-express.json', function (req, res) {
	const responseObject = {
		works: true
	};
	res.send(JSON.stringify(responseObject, 4, null));
});
<% if (mangonyExpress !== true) { %>
app.set('port', process.env.PORT || 3000);

/**
 * serves the static folders
 */
app.use(express.static(args[2]));

app.listen(app.get('port'), function () {
	console.log('Express server started on port ' + app.get('port') + ' serving static files from ' + args[2] + ' folder.');
});
<% } %>
module.exports = app;